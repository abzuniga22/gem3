{% extends 'base.html' %}
{% block title %}Model {{ m['model'] }} â€“ GEM3{% endblock %}
{% block content %}
<header class="page-header">
  <h2 style="margin-bottom: .25rem;">{{ m['model'] }}</h2>
  <p class="muted" style="margin-top: 0;">
    Organism: {{ m['organism'] }} |
    Type: {{ m['pro_euk'] }} |
    Respiration: {{ m['respiration'] }} |
    Cell type: {{ m['cell_type'] }}
    {% set p = paper_url(m['model']) %}
    {% if p %} | Reference: <a href="{{ p }}" target="_blank" rel="noopener">paper</a>{% endif %}
  </p>

  <!-- Quick tools: JSON + CSV exports -->
  <nav class="toolbar" style="display:flex; gap:.5rem; flex-wrap: wrap; margin: .5rem 0 1rem;">
    <a class="btn" href="{{ url_for('export_scope_csv', scope='model', q=m['model']) }}">Models CSV</a>
    <a class="btn" href="{{ url_for('export_scope_csv', scope='reaction', q=m['model']) }}">Reactions CSV</a>
    <a class="btn" href="{{ url_for('export_scope_csv', scope='metabolite', q=m['model']) }}">Metabolites CSV</a>
    <a class="btn" href="{{ url_for('export_scope_csv', scope='gene', q=m['model']) }}">Genes CSV</a>
  </nav>
</header>

<h3>Overview</h3>
<ul>
  <li>Reactions: {{ n_rxn }}</li>
  <li>Metabolites: {{ n_met }}</li>
  <li>Genes: {{ n_gene }}</li>
</ul>

<h3>Reactions</h3>
<p class="muted" style="margin:.25rem 0 .5rem;">
  <a href="{{ url_for('export_scope_csv', scope='reaction', q=m['model']) }}">Download reactions (CSV)</a>
</p>
<table>
  <tr><th>ID</th><th>Equation</th><th>Pathway</th></tr>
  {% for r in reactions %}
  <tr>
    <td>{{ r['reaction_id'] | autolink }}</td>
    <td>{{ r['equation'] | autolink }}</td>
    <td>{{ r['pathway']  | autolink }}</td>
  </tr>
  {% endfor %}
</table>
{% if rpages > 1 %}
  <div class="muted">
    Page {{ rpage }} of {{ rpages }}
    {% if rpage > 1 %}
      <a href="{{ url_for('model_detail', model=m['model'], rpage=1,   mpage=mpage, gpage=gpage) }}">First</a>
      <a href="{{ url_for('model_detail', model=m['model'], rpage=rpage-1, mpage=mpage, gpage=gpage) }}">Prev</a>
    {% endif %}
    {% if rpage < rpages %}
      <a href="{{ url_for('model_detail', model=m['model'], rpage=rpage+1, mpage=mpage, gpage=gpage) }}">Next</a>
      <a href="{{ url_for('model_detail', model=m['model'], rpage=rpages, mpage=mpage, gpage=gpage) }}">Last</a>
    {% endif %}
  </div>
{% endif %}

<h3>Metabolites</h3>
<p class="muted" style="margin:.25rem 0 .5rem;">
  <a href="{{ url_for('export_scope_csv', scope='metabolite', q=m['model']) }}">Download metabolites (CSV)</a>
</p>
<table>
  <tr><th>ID</th><th>Name</th><th>Formula</th><th>Compartment</th></tr>
  {% for mt in metabolites %}
  <tr>
    <td>{{ mt['metabolite_id'] | autolink }}</td>
    <td>{{ mt['name']  | autolink }}</td>
    <td>{{ mt['formula'] }}</td>
    <td>{{ mt['compartment'] }}</td>
  </tr>
  {% endfor %}
</table>
{% if mpages > 1 %}
  <div class="muted">
    Page {{ mpage }} of {{ mpages }}
    {% if mpage > 1 %}
      <a href="{{ url_for('model_detail', model=m['model'], rpage=rpage, mpage=1,     gpage=gpage) }}">First</a>
      <a href="{{ url_for('model_detail', model=m['model'], rpage=rpage, mpage=mpage-1, gpage=gpage) }}">Prev</a>
    {% endif %}
    {% if mpage < mpages %}
      <a href="{{ url_for('model_detail', model=m['model'], rpage=rpage, mpage=mpage+1, gpage=gpage) }}">Next</a>
      <a href="{{ url_for('model_detail', model=m['model'], rpage=rpage, mpage=mpages,  gpage=gpage) }}">Last</a>
    {% endif %}
  </div>
{% endif %}

<h3>Genes</h3>
<p class="muted" style="margin:.25rem 0 .5rem;">
  <a href="{{ url_for('export_scope_csv', scope='gene', q=m['model']) }}">Download genes (CSV)</a>
</p>
<table>
  <tr><th>ID</th><th>Protein</th></tr>
  {% for g in genes %}
  <tr>
    <td>{{ g['gene_id'] | autolink }}</td>
    <td>{{ g['protein'] | autolink  }}</td>
  </tr>
  {% endfor %}
</table>
{% if gpages > 1 %}
  <div class="muted">
    Page {{ gpage }} of {{ gpages }}
    {% if gpage > 1 %}
      <a href="{{ url_for('model_detail', model=m['model'], rpage=rpage, mpage=mpage, gpage=1) }}">First</a>
      <a href="{{ url_for('model_detail', model=m['model'], rpage=rpage, mpage=mpage, gpage=gpage-1) }}">Prev</a>
    {% endif %}
    {% if gpage < gpages %}
      <a href="{{ url_for('model_detail', model=m['model'], rpage=rpage, mpage=mpage, gpage=gpage+1) }}">Next</a>
      <a href="{{ url_for('model_detail', model=m['model'], rpage=rpage, mpage=mpage, gpage=gpages) }}">Last</a>
    {% endif %}
  </div>
{% endif %}

<!-- Models download section (global binaries) -->
<section style="margin-top:1.25rem;">
  <h3>Available Model Files</h3>
  {% if model_groups %}
    {% for model_name, files in model_groups %}
      <details>
        <summary><strong>{{ model_name }}</strong></summary>
        <ul>
          {% for file_name, href in files %}
            <li><a href="{{ href }}" download>{{ file_name }}</a></li>
          {% endfor %}
        </ul>
      </details>
    {% endfor %}
  {% else %}
    <p class="muted">No model files found. Add .xml/.mat/.json files to <code>static/models/</code> and redeploy.</p>
  {% endif %}
</section>
{% endblock %}
